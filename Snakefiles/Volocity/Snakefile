import pandas as pd

meta = pd.read_csv(
    "/storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/velocyto/meta.csv"
)
samples = meta["samples"].tolist()
sample2barcodes = dict(zip(meta["samples"].tolist(), meta["barcodes"].tolist()))
sample2bams = dict(zip(meta["samples"].tolist(), meta["bams"].tolist()))
genome = "/storage/singlecell/zz4/Reference/refdata-cellranger-arc-GRCh38-2020-A/genes/genes.gtf"


def get_barcodes(wildcards):
    return sample2barcodes[wildcards.sample]


def get_bam(wildcards):
    return sample2bams[wildcards.sample]


rule all:
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_wadult_MG_ldata.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics_vk.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics_g.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/to_terminal_states.csv",
        "/storage/singlecell/zz4/fetal_snakemake/results/NRPC_fate/NRPC_fate.h5ad",



rule velocyto:
    ## Run velocyto
    input:
        get_barcodes,
        get_bam,
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/{sample}.loom",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate velocyto
        export LC_ALL=en_US.utf-8
        export LANG=en_US.utf-8
        mkdir /storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/
        velocyto run -o /storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/ -@ 12 --samtools-memory 10240 --bcfile /storage/singlecell/zz4/fetal_snakemake/data/Retina_fetal/{wildcards.sample}/outs/filtered_feature_bc_matrix/barcodes.tsv.gz -e {wildcards.sample} /storage/singlecell/zz4/fetal_snakemake/data/Retina_fetal/{wildcards.sample}/outs/gex_possorted_bam.bam {genome}'
        """


rule velocyto_adult:
    ## Run velocyto
    input:
        "/storage/singlecell/zz4/fetal_snakemake/data/adult_data/10x3_Lobe_19_D019_NeuN-v7/filtered_feature_bc_matrix/barcodes.tsv.gz",
        "/storage/singlecell/zz4/fetal_snakemake/data/adult_data/10x3_Lobe_19_D019_NeuN-v7/possorted_genome_bam.bam",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/10x3_Lobe_19_D019_NeuN-v7.loom",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate velocyto
        export LC_ALL=en_US.utf-8
        export LANG=en_US.utf-8
        mkdir /storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/
        velocyto run -o /storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/ -@ 12 --samtools-memory 20240 --bcfile /storage/singlecell/zz4/fetal_snakemake/data/adult_data/10x3_Lobe_19_D019_NeuN-v7/filtered_feature_bc_matrix/barcodes.tsv.gz -e 10x3_Lobe_19_D019_NeuN-v7 /storage/singlecell/zz4/fetal_snakemake/data/adult_data/10x3_Lobe_19_D019_NeuN-v7/possorted_genome_bam.bam {genome}'
        """


rule merge_looms:
    ##
    input:
        expand(
            [
                "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/{sample}.loom",
            ],
            sample=samples,
        ),
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/10x3_Lobe_19_D019_NeuN-v7.loom",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/combined.loom",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        mkdir /storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/merge_looms/merge_looms.py'
        """


rule convert_loom_to_h5ad:
    ##
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/combined.loom",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/combined.h5ad",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        mkdir /storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/convert_loom_to_h5ad/convert_loom_to_h5ad.py'
        """

rule add_loom_to_h5ad_with_or_without_2_adult:
    ## Add loom file to merged without adult
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_wadult_MG.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/RNA_velocity/combined.h5ad",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_wadult_MG_ldata.h5ad",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/add_ldata_to_adata_wo_adult/add_ldata_to_adata_wo_adult.py
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/add_ldata_to_adata/add_ldata_to_adata.py'
        """


rule recover_dynamic:
    ## Add loom file to merged without adult
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_wadult_MG_ldata.h5ad",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_wadult_MG_ldata_dynamics.h5ad",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/recover_dynamic/recover_dynamic.py'
        """


rule compute_vk:
    ## Add loom file to merged without adult
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics.h5ad",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics_vk.h5ad",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/compute_vk/compute_vk.py'
        """


rule infer_fate:
    ## Add loom file to merged without adult
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics_vk.h5ad",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/merged_raw_filtered_umap_10000_woadult_MG_ldata_dynamics_g.h5ad",
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/to_terminal_states.csv",
    shell:
        """
        bash -c '
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/infer_fate/infer_fate.py'
        """


rule infer_fate_NRPC:
    ## Add loom file to merged without adult
    input:
        "/storage/singlecell/zz4/fetal_snakemake/results/merged_h5ad/to_terminal_states.csv",
    output:
        "/storage/singlecell/zz4/fetal_snakemake/results/NRPC_fate/NRPC_fate.h5ad",
    shell:
        """
        bash -c '
        export CUDA_VISIBLE_DEVICES=1
        source /storage/singlecell/zz4/mambaforge/etc/profile.d/conda.sh && conda activate python
        python3.9 /storage/singlecell/zz4/fetal_snakemake/scripts/Volocity/infer_fate_NRPC/infer_fate_NRPC.py'
        """
